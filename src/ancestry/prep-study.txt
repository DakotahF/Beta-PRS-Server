#!/bin/bash
#SBATCH --job-name=ancestry-prep

ukbbsnps='/net/hunt/home/kotah/prs-server-beta/ancestry/cran/reference/ancestry-snps.ids'
inputfile=$1
outputdir=$2
name=${inputfile##*/}
foldername="${name%.vcf.gz}"
resultdir="$outputdir/results"
qcdir="$outputdir/qcdir"

sbatch --job-name=prune-and-filter --mem=60G --wrap="
echo $name

mkdir $outputdir/$foldername
if [ ! -f $outputdir/$foldername/$foldername.bed ]; then
    plink-1.9 --vcf $inputfile --make-bed --out $outputdir/$foldername/$foldername
fi

mkdir $qcdir/$foldername
if [ ! -f $qcdir/$foldername/$foldername.filter ]; then
    plink-1.9 --bfile $outputdir/$foldername/$foldername \
              --indep-pairwise 50 5 0.2 \
               --out $qcdir/$foldername/$foldername.filter
fi

if [ ! -f $qcdir/$foldername/$foldername.filtered ]; then
    plink-1.9 --bfile $outputdir/$foldername/$foldername \
        --extract $qcdir/$foldername/$foldername.filter.prune.in \
        --make-bed \
        --out $qcdir/$foldername/$foldername.filtered
fi

#prune input file based on ukbb snps
if [ ! $qcdir/$foldername/$foldername.filtered.pruned ]; then 
plink-1.9 --bfile $qcdir/$foldername/$foldername.filtered \
      --extract $ukbbsnps \
      --make-bed \
      --out $qcdir/$foldername/$foldername.filtered.pruned
fi 

echo $qcdir/$foldername/$foldername.filtered.pruned >> $resultdir/cleaned_sample_list.txt
"

